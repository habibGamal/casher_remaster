var c=Object.defineProperty;var p=(e,t,u)=>t in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:u}):e[t]=u;var i=(e,t,u)=>(p(e,typeof t!="symbol"?t+"":t,u),u);import{N as d,D as h}from"./NoInvoiceOperations.d413b086.js";import{x as o,v as n,b3 as l,j as y}from"./app.3aad4e87.js";import{C as m}from"./CreateInvoiceManager.55a1c683.js";import{f as _,d as b}from"./errorHandlers.e584f717.js";import"./PageTitle.30585599.js";import"./index.05831a02.js";import"./CheckOutlined.241343e2.js";import"./styleChecker.8ba932ef.js";import"./index.3e4aed6b.js";import"./index.39d1b77e.js";import"./mapEditableColumns.84f88b83.js";import"./index.4d07e239.js";import"./useSearch.9125f7ac.js";import"./index.d9a9a89c.js";import"./index.fe1d2ba1.js";import"./Table.611ad66a.js";import"./index.28850fea.js";import"./index.c383cf70.js";class f{constructor(t){this.props=t,this.edit=this.edit.bind(this),this.cancelOperation=this.cancelOperation.bind(this),this.getInvoiceItems=this.getInvoiceItems.bind(this)}isReturnQuantityValid(t){const u=t.return_quantity<=t.available_quantity;return u||o.error("\u0627\u0644\u0643\u0645\u064A\u0629 \u0627\u0644\u0645\u0631\u062A\u062C\u0639\u0629 \u0623\u0643\u0628\u0631 \u0645\u0646 \u0627\u0644\u0643\u0645\u064A\u0629 \u0627\u0644\u0645\u062A\u0627\u062D\u0629"),u}correctTotal(t){return t.return_quantity=t.children.reduce((u,r)=>u+parseFloat(r.return_quantity.toString()),0),t.total=parseFloat((t.return_quantity*t.return_price).toFixed(2)),t}getInvoiceItems(){return this.props.invoiceItems}edit(t){const u=this.props.invoiceItems.map(r=>!(r.id==t.id)||!this.isReturnQuantityValid(t)?r:(r.children=r.children.map(s=>s.key!=t.key?s:t),this.correctTotal(r)));this.props.setInvoiceItems(u)}cancelOperation(){this.props.setInvoiceItems([])}}class S extends m{constructor(u){super();i(this,"search");i(this,"submit");i(this,"invoiceOperations");i(this,"returnInvoiceOperations");this.props=u,this.invoiceOperations=new d(null),this.returnInvoiceOperations=new f(u),this.afterSearch=this.afterSearch.bind(this),this.search=new k({attribute:this.props.search.data.attribute,value:this.props.search.data.value},this.afterSearch),this.submit=new x(this.props)}afterSearch(u,r){this.props.setInvoiceItems(u),this.props.setAdditionalData({buyingInvoiceId:r}),this.props.search.changeSearchValue("")}}class k{constructor(t,u){i(this,"factory");this.searchParams=t,this.afterSearch=u,this.onSearch=this.onSearch.bind(this),this.factory=new v}onSearch(){n.Inertia.reload({data:this.searchParams,only:["buying_invoice"],preserveState:!0,onSuccess:t=>{const u=t.props.buying_invoice;if(u===null)return o.error("\u0644\u0627 \u064A\u0648\u062C\u062F \u0641\u0627\u062A\u0648\u0631\u0629 \u0634\u0631\u0627\u0621 \u0628\u0647\u0630\u0627 \u0627\u0644\u0631\u0642\u0645");const r=this.factory.factory(u);this.afterSearch(r,u.id)}})}}class v{factory(t){return t.buying_invoice_items.map(u=>({id:u.id,key:u.id.toString(),product_id:u.box.product.id,available_quantity:u.box.stock_items.reduce((r,a)=>r+a.quantity,0),return_quantity:0,name:u.box.product.name,barcode:u.box.product.barcode,buying_price:u.box.buying_price,return_price:u.box.buying_price,stock:"-",stock_item_id:0,children:u.box.stock_items.map((r,a)=>({id:u.id,key:`${a}-${u.box.product.barcode}`,stock_item_id:r.id,available_quantity:r.quantity,return_quantity:0,stock:r.stock.name})),total:0}))}}class x{constructor(t){this.props=t,this.onSubmit=this.onSubmit.bind(this)}remapItemsToSubmit(){const t=[];return this.props.invoiceItems.forEach(u=>u.children.forEach(r=>{t.push({product_id:u.product_id,stock_item_id:r.stock_item_id,quantity:r.return_quantity,return_price:u.return_price})})),t}onSubmit(){this.props.setLoading(!0),n.Inertia.post(l.storeURL(),{invoiceItems:this.remapItemsToSubmit(),buying_invoice_id:this.props.additionalData.buyingInvoiceId},{onSuccess:t=>{this.props.setLoading(!1),_(t)||this.props.setInvoiceItems([])},onError:t=>{this.props.setLoading(!1),b(t)}})}}function Q(){return y(h,{title:"\u0641\u0627\u062A\u0648\u0631\u0629 \u0645\u0631\u062A\u062C\u0639 \u0634\u0631\u0627\u0621",defaultColumns:[{title:"\u0623\u0633\u0645 \u0627\u0644\u0635\u0646\u0641",dataIndex:"name",key:"name"},{title:"\u0643\u0648\u062F \u0627\u0644\u0635\u0646\u0641",dataIndex:"barcode",key:"barcode"},{title:"\u0633\u0639\u0631 \u0634\u0631\u0627\u0621 \u0627\u0644\u0648\u062D\u062F\u0629",dataIndex:"buying_price",key:"buying_price"},{title:"\u0633\u0639\u0631 \u0645\u0631\u062A\u062C\u0639 \u0627\u0644\u0648\u062D\u062F\u0629",dataIndex:"return_price",key:"return_price",editable:!0},{title:"\u0627\u0644\u0645\u062E\u0632\u0646",dataIndex:"stock",key:"stock"},{title:"\u0639\u062F\u062F \u0627\u0644\u0648\u062D\u062F\u0627\u062A \u0627\u0644\u0645\u062A\u0627\u062D\u0629",dataIndex:"available_quantity",key:"available_quantity"},{title:"\u0639\u062F\u062F \u0627\u0644\u0648\u062D\u062F\u0627\u062A \u0627\u0644\u0645\u0631\u062A\u062C\u0639\u0629",dataIndex:"return_quantity",key:"return_quantity",editable:!0},{title:"\u0627\u0644\u0627\u062C\u0645\u0627\u0644\u064A",dataIndex:"total",key:"total"}],getManager:S})}export{Q as default};
