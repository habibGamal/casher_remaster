var l=Object.defineProperty;var p=(u,t,e)=>t in u?l(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var a=(u,t,e)=>(p(u,typeof t!="symbol"?t+"":t,e),e);import{N as d,D as h}from"./NoInvoiceOperations.d413b086.js";import{x as n,v as c,b1 as m,j as v}from"./app.3aad4e87.js";import{C as I}from"./CreateInvoiceManager.55a1c683.js";import{f as _,d as y}from"./errorHandlers.e584f717.js";import"./PageTitle.30585599.js";import"./index.05831a02.js";import"./CheckOutlined.241343e2.js";import"./styleChecker.8ba932ef.js";import"./index.3e4aed6b.js";import"./index.39d1b77e.js";import"./mapEditableColumns.84f88b83.js";import"./index.4d07e239.js";import"./useSearch.9125f7ac.js";import"./index.d9a9a89c.js";import"./index.fe1d2ba1.js";import"./Table.611ad66a.js";import"./index.28850fea.js";import"./index.c383cf70.js";class b{constructor(t){this.props=t,this.edit=this.edit.bind(this),this.cancelOperation=this.cancelOperation.bind(this),this.getInvoiceItems=this.getInvoiceItems.bind(this)}isReturnQuantityValid(t){const e=t.return_quantity<=t.available_quantity;return e||n.error("\u0627\u0644\u0643\u0645\u064A\u0629 \u0627\u0644\u0645\u0631\u062A\u062C\u0639\u0629 \u0623\u0643\u0628\u0631 \u0645\u0646 \u0627\u0644\u0643\u0645\u064A\u0629 \u0627\u0644\u0645\u062A\u0627\u062D\u0629"),e}correctTotal(t){const e=t.return_price*t.return_quantity;return{...t,total:parseFloat(e.toFixed(2))}}getInvoiceItems(){return this.props.invoiceItems}edit(t){const e=this.props.invoiceItems.map(i=>!(i.id===t.id)||!this.isReturnQuantityValid(t)?i:this.correctTotal(t));this.props.setInvoiceItems(e)}cancelOperation(){this.props.setInvoiceItems([])}}class f extends I{constructor(e){super();a(this,"search");a(this,"submit");a(this,"invoiceOperations");a(this,"returnInvoiceOperations");this.props=e,this.invoiceOperations=new d(null),this.returnInvoiceOperations=new b(e),this.afterSearch=this.afterSearch.bind(this),this.search=new g({attribute:this.props.search.data.attribute,value:this.props.search.data.value},this.afterSearch),this.submit=new A(this.props)}afterSearch(e,i){this.props.setInvoiceItems(e),this.props.setAdditionalData({sellingInvoiceId:i}),this.props.search.changeSearchValue("")}}class g{constructor(t,e){a(this,"factory");this.searchParams=t,this.afterSearch=e,this.onSearch=this.onSearch.bind(this),this.factory=new S}onSearch(){c.Inertia.reload({data:this.searchParams,only:["selling_invoice"],preserveState:!0,onSuccess:t=>{const e=t.props.selling_invoice;if(e===null)return n.error("\u0644\u0627 \u064A\u0648\u062C\u062F \u0641\u0627\u062A\u0648\u0631\u0629 \u0634\u0631\u0627\u0621 \u0628\u0647\u0630\u0627 \u0627\u0644\u0631\u0642\u0645");const i=this.factory.factory(e);this.afterSearch(i,e.id)}})}}class S{processInvoice(t){const e=this.mergeSellingInvoiceItems(t.selling_invoice_items),i=t.return_selling_invoices.map(s=>s.items).flat();return this.calculateAvailableReturnQuantities(e,i)}mergeSellingInvoiceItems(t){const e=new Map;return t.forEach(i=>{const{stock_item:{box:{product_id:r}},quantity:s}=i,o=e.get(r);o?o.quantity+=s:e.set(r,{...i,quantity:s})}),Array.from(e.values())}calculateAvailableReturnQuantities(t,e){const i=new Map;return t.forEach(r=>{i.set(r.stock_item.box.product_id,r)}),e.forEach(r=>{const s=i.get(r.product_id);s&&(s.quantity-=r.quantity,i.set(r.product_id,s))}),Array.from(i.values())}factory(t){return this.processInvoice(t).map(e=>({key:e.stock_item.id.toString(),id:e.stock_item.id,product_id:e.stock_item.box.product_id,available_quantity:e.quantity,return_quantity:0,name:e.stock_item.box.product.name,barcode:e.stock_item.box.product.barcode,selling_price:e.selling_price,return_price:e.selling_price,total:0}))}}class A{constructor(t){this.props=t,this.onSubmit=this.onSubmit.bind(this)}remapItemsToSubmit(){return this.props.invoiceItems.map(t=>({stock_item_id:t.id,product_id:t.product_id,quantity:t.return_quantity,return_price:t.return_price,total:t.total}))}onSubmit(){this.props.setLoading(!0),console.log(this.props),c.Inertia.post(m.storeURL(),{invoiceItems:this.remapItemsToSubmit(),selling_invoice_id:this.props.additionalData.sellingInvoiceId},{onSuccess:t=>{this.props.setLoading(!1),_(t)||this.props.setInvoiceItems([])},onError:t=>{this.props.setLoading(!1),y(t)}})}}function B(){return v(h,{title:"\u0641\u0627\u062A\u0648\u0631\u0629 \u0645\u0631\u062A\u062C\u0639 \u0628\u064A\u0639",defaultColumns:[{title:"\u0623\u0633\u0645 \u0627\u0644\u0635\u0646\u0641",dataIndex:"name",key:"name"},{title:"\u0643\u0648\u062F \u0627\u0644\u0635\u0646\u0641",dataIndex:"barcode",key:"barcode"},{title:"\u0633\u0639\u0631 \u0628\u064A\u0639 \u0627\u0644\u0648\u062D\u062F\u0629",dataIndex:"selling_price",key:"selling_price"},{title:"\u0633\u0639\u0631 \u0645\u0631\u062A\u062C\u0639 \u0627\u0644\u0648\u062D\u062F\u0629",dataIndex:"return_price",key:"return_price",editable:!0},{title:"\u0639\u062F\u062F \u0627\u0644\u0648\u062D\u062F\u0627\u062A \u0627\u0644\u0645\u062A\u0627\u062D\u0629",dataIndex:"available_quantity",key:"available_quantity"},{title:"\u0639\u062F\u062F \u0627\u0644\u0648\u062D\u062F\u0627\u062A \u0627\u0644\u0645\u0631\u062A\u062C\u0639\u0629",dataIndex:"return_quantity",key:"return_quantity",editable:!0},{title:"\u0627\u0644\u0627\u062C\u0645\u0627\u0644\u064A",dataIndex:"total",key:"total"}],getManager:f})}export{B as default};
